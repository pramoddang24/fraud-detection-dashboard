<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smarter Fraud Detection: An AI Agent Showdown</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Socket.IO Client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            background-attachment: fixed;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .card {
            background-color: rgba(28, 37, 51, 0.92);
            backdrop-filter: blur(15px);
            border-radius: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 64rem; /* 1024px */
        }
        .text-gradient {
            background: linear-gradient(90deg, #a78bfa, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .fade-in {
            animation: fadeIn 0.8s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .scrollable-panel {
            max-height: 16rem; /* fixed height for consistent layout */
            overflow-y: auto;
        }
    </style>
</head>
<body class="text-gray-200">

    <div class="card p-6 sm:p-8 md:p-12 fade-in">
        <div id="dashboard-container">
            <h2 class="text-3xl sm:text-4xl font-bold mb-6 text-center text-gradient">Smarter Fraud Detection: An AI Agent Showdown</h2>
            <div class="bg-gray-900/80 p-4 rounded-xl shadow-2xl border-2 border-gray-700">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="lg:col-span-1 space-y-4">
                        <!-- Controls Panel -->
                        <div class="bg-gray-800/80 p-4 rounded-lg ring-1 ring-gray-700 flex flex-col">
                            <h3 class="text-white font-bold mb-2 flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-400" viewBox="0 0 20 20" fill="currentColor">
                                  <path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 00-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0v-7.268a2 2 0 000-3.464V4zM17 4a1 1 0 00-2 0v11a1 1 0 102 0V4z"/>
                                </svg>
                                <span>Dashboard Controls</span>
                            </h3>
                            <div class="flex space-x-2">
                                <button id="start-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Start Stream</button>
                                <button id="stop-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Stop Stream</button>
                            </div>
                            <div class="mt-4 flex items-center justify-center space-x-4">
                                <label for="model-select" class="text-gray-400 font-semibold">Active Model:</label>
                                <select id="model-select" class="bg-gray-700 text-gray-200 rounded-lg p-2 focus:ring-purple-500 focus:border-purple-500">
                                    <option value="thompson_sampling">Thompson Sampling</option>
                                    <option value="ucb1">UCB1</option>
                                    <option value="logistic_regression">Logistic Regression</option>
                                </select>
                            </div>
                            <div class="mt-4 text-center">
                                <span id="status-indicator" class="inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium bg-red-800 text-red-300">
                                    <svg class="-ml-1 mr-1.5 h-2 w-2 text-red-400" fill="currentColor" viewBox="0 0 8 8">
                                        <circle cx="4" cy="4" r="3" />
                                    </svg>
                                    Stopped
                                </span>
                            </div>
                        </div>

                        <!-- Key Metrics -->
                        <div class="bg-gray-800/80 p-4 rounded-lg ring-1 ring-gray-700">
                            <h3 class="text-white font-bold mb-2 flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-teal-300" viewBox="0 0 20 20" fill="currentColor">
                                  <path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.545 4.545a1 1 0 00-.707 1.707l.707.707a1 1 0 001.707-.707l-.707-.707a1 1 0 00-.707-.707zM16 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM4.455 4.545a1 1 0 00-1.707.707l.707.707a1 1 0 10-.707 1.707l-.707-.707a1 1 0 001.707-1.707zM3 11a1 1 0 100-2h-1a1 1 0 100 2h1zM12 16a1 1 0 10-2 0v1a1 1 0 102 0v-1zM4.455 15.455a1 1 0 00-.707-.707l-.707.707a1 1 0 001.707 1.707l.707-.707a1 1 0 00-.707-1.707zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zM11 16a1 1 0 10-2 0v1a1 1 0 102 0v-1zM15.545 15.455a1 1 0 00-.707.707l.707.707a1 1 0 001.707-1.707l-.707-.707a1 1 0 00-.707-.707zM16 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM4.455 4.545a1 1 0 00-1.707.707l.707.707a1 1 0 10-.707 1.707l-.707-.707a1 1 0 001.707-1.707zM3 11a1 1 0 100-2h-1a1 1 0 100 2h1zM12 16a1 1 0 10-2 0v1a1 1 0 102 0v-1zM4.455 15.455a1 1 0 00-.707-.707l-.707.707a1 1 0 001.707 1.707l.707-.707a1 1 0 00-.707-1.707z" />
                                </svg>
                                <span>Key Metrics</span>
                            </h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-gray-400 text-sm">Total Transactions</p>
                                    <p id="metric-total-txns" class="text-2xl font-bold text-teal-300">0</p>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-sm">Fraud Alerts</p>
                                    <p id="metric-fraud-alerts" class="text-2xl font-bold text-red-400">0</p>
                                </div>
                            </div>
                            <div class="mt-4">
                                <p class="text-gray-400 text-sm">Cumulative Regret (TS)</p>
                                <p id="metric-ts-regret" class="text-2xl font-bold text-pink-400">0.00</p>
                            </div>
                            <div class="mt-4">
                                <p class="text-gray-400 text-sm">Cumulative Regret (UCB1)</p>
                                <p id="metric-ucb1-regret" class="text-2xl font-bold text-blue-400">0.00</p>
                            </div>
                        </div>

                        <!-- Model Performance Insights -->
                        <div class="bg-gray-800/80 p-4 rounded-lg ring-1 ring-gray-700">
                            <h3 class="text-white font-bold mb-2 flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-8a1 1 0 112 0v4a1 1 0 11-2 0v-4zm-1-4a1 1 0 102 0V5a1 1 0 10-2 0v1z" clip-rule="evenodd" />
                                </svg>
                                <span>Model Performance Insights</span>
                            </h3>
                            <p id="performance-insights" class="text-lg text-gray-300 italic">Start the stream to see model insights...</p>
                        </div>

                        <!-- Real-time Transaction Feed -->
                        <div class="bg-gray-800/80 p-4 rounded-lg ring-1 ring-gray-700 scrollable-panel">
                            <h3 class="text-teal-300 font-bold mb-2 flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-teal-300" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-8a1 1 0 112 0v4a1 1 0 11-2 0v-4zm-1-4a1 1 0 102 0V5a1 1 0 10-2 0v1z" clip-rule="evenodd" />
                                </svg>
                                <span>Real-time Transaction Feed</span>
                            </h3>
                            <div id="transaction-feed" class="text-sm space-y-2"></div>
                        </div>

                        <!-- Fraud Alerts Dashboard -->
                        <div class="bg-gray-800/80 p-4 rounded-lg ring-1 ring-gray-700 scrollable-panel">
                            <h3 class="text-red-400 font-bold mb-2 flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9 5a1 1 0 10-2 0v6a1 1 0 102 0V5z" clip-rule="evenodd" />
                                </svg>
                                <span>Fraud Alerts Dashboard</span>
                            </h3>
                            <div id="alert-feed" class="text-sm space-y-2"></div>
                        </div>
                    </div>

                    <!-- Right column for charts -->
                    <div class="lg:col-span-2 space-y-4">
                        <div class="bg-gray-800/80 p-4 rounded-lg ring-1 ring-gray-700">
                            <h3 class="text-white font-bold mb-2 text-center">Cumulative Regret Over Time</h3>
                            <canvas id="regretChart"></canvas>
                        </div>
                        <div class="bg-gray-800/80 p-4 rounded-lg ring-1 ring-gray-700">
                            <h3 class="text-white font-bold mb-2 text-center">Precision@100 (TS vs. LR)</h3>
                            <canvas id="precisionChart" style="max-height: 200px;"></canvas>
                        </div>
                        <div class="bg-gray-800/80 p-4 rounded-lg ring-1 ring-gray-700">
                            <h3 class="text-white font-bold mb-2 text-center">Live Cluster Distribution (GMM)</h3>
                            <canvas id="clusterChart" style="max-height: 200px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof WebSocket === 'undefined') {
                document.body.innerHTML = '<div class="text-center text-red-500 text-lg">WebSockets not supported. Please use a modern browser.</div>';
                return;
            }

            const socket = io();

            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const modelSelect = document.getElementById('model-select');
            const statusIndicator = document.getElementById('status-indicator');

            const transactionFeed = document.getElementById('transaction-feed');
            const alertFeed = document.getElementById('alert-feed');

            const metricTotalTxns = document.getElementById('metric-total-txns');
            const metricFraudAlerts = document.getElementById('metric-fraud-alerts');
            const metricTsRegret = document.getElementById('metric-ts-regret');
            const metricUcb1Regret = document.getElementById('metric-ucb1-regret');
            const performanceInsights = document.getElementById('performance-insights');

            let regretChart, clusterChart, precisionChart;
            let step = 0;
            let totalTxns = 0;
            let fraudAlertsCount = 0;

            let currentModel = modelSelect.value;
            modelSelect.addEventListener('change', (event) => {
                currentModel = event.target.value;
                resetDashboard();
                socket.emit('set_model', { model: currentModel });
            });

            function createCharts() {
                Chart.defaults.color = '#9ca3af';
                Chart.defaults.font.family = "'Inter', sans-serif";

                const regretCtx = document.getElementById('regretChart').getContext('2d');
                regretChart = new Chart(regretCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Thompson Sampling',
                            data: [],
                            borderColor: '#ec4899',
                            backgroundColor: 'rgba(236, 72, 153, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            fill: true
                        }, {
                            label: 'UCB1',
                            data: [],
                            borderColor: '#60a5fa',
                            backgroundColor: 'rgba(96, 165, 250, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            fill: true
                        }]
                    },
                    options: {
                        scales: {
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, title: { display: true, text: 'Cumulative Regret' } },
                            x: { grid: { color: 'rgba(255,255,255,0.1)' }, title: { display: true, text: 'Steps' } }
                        },
                        plugins: {
                            legend: { labels: { color: '#d1d5db' } }
                        }
                    }
                });

                const precisionCtx = document.getElementById('precisionChart').getContext('2d');
                precisionChart = new Chart(precisionCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Thompson Sampling', 'Logistic Regression'],
                        datasets: [{
                            label: 'Precision@100',
                            data: [0, 0],
                            backgroundColor: ['#f472b6', '#a78bfa'],
                            borderColor: '#1f2937',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 1.0,
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                title: { display: true, text: 'Precision@100 Score' }
                            },
                            x: {
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });

                const clusterCtx = document.getElementById('clusterChart').getContext('2d');
                clusterChart = new Chart(clusterCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Cluster 1 (Low Risk)', 'Cluster 2 (Med Risk)', 'Cluster 3 (High Risk)', 'Cluster 4 (Anomalies)'],
                        datasets: [{
                            data: [],
                            backgroundColor: ['#3b82f6', '#14b8a6', '#f59e0b', '#ef4444'],
                            borderColor: '#1f2937',
                            borderWidth: 2,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { color: '#d1d5db' } }
                        }
                    }
                });
            }

            function resetDashboard() {
                step = 0;
                totalTxns = 0;
                fraudAlertsCount = 0;

                metricTotalTxns.textContent = '0';
                metricFraudAlerts.textContent = '0';
                metricTsRegret.textContent = '0.00';
                metricUcb1Regret.textContent = '0.00';
                performanceInsights.textContent = 'Start the stream to see model insights...';

                transactionFeed.innerHTML = '';
                alertFeed.innerHTML = '';

                regretChart.data.labels = [];
                regretChart.data.datasets[0].data = [];
                regretChart.data.datasets[1].data = [];
                regretChart.update('none');

                precisionChart.data.datasets[0].data = [0, 0];
                precisionChart.update('none');

                clusterChart.data.datasets[0].data = [];
                clusterChart.update('none');
            }

            createCharts();

            // --- Button event listeners ---
            startBtn.addEventListener('click', () => {
                resetDashboard(); // Reset state on start
                socket.emit('start_streaming', { model: currentModel });
                statusIndicator.innerHTML = '<svg class="-ml-1 mr-1.5 h-2 w-2 text-green-400" fill="currentColor" viewBox="0 0 8 8"><circle cx="4" cy="4" r="3" /></svg>Running';
                statusIndicator.classList.remove('bg-red-800', 'text-red-300');
                statusIndicator.classList.add('bg-green-800', 'text-green-300');
            });

            stopBtn.addEventListener('click', () => {
                socket.emit('stop_streaming');
                statusIndicator.innerHTML = '<svg class="-ml-1 mr-1.5 h-2 w-2 text-red-400" fill="currentColor" viewBox="0 0 8 8"><circle cx="4" cy="4" r="3" /></svg>Stopped';
                statusIndicator.classList.remove('bg-green-800', 'text-green-300');
                statusIndicator.classList.add('bg-red-800', 'text-red-300');
            });

            // --- SocketIO event handlers ---
            socket.on('connect', function() {
                console.log('Connected to WebSocket server');
            });

            socket.on('disconnect', function() {
                console.log('Disconnected from WebSocket server');
            });

            socket.on('streaming_data', function(data) {
                const transaction = data.transaction;
                const prediction = data.prediction;
                const mabs = data.mab_performance;
                const clusterCounts = data.cluster_distribution;

                totalTxns++;

                const isFraud = prediction.is_fraud;
                const statusClass = isFraud ? 'text-red-400 font-bold' : 'text-green-400';
                const statusText = isFraud ? 'FLAGGED' : 'OK';

                const transactionItem = document.createElement('div');
                transactionItem.className = 'py-1 border-b border-gray-700';
                transactionItem.innerHTML = `
                    <p class="text-gray-400">
                        <span class="font-mono text-gray-500">${transaction.timestamp}</span> -
                        <span class="text-teal-300 font-mono">$${transaction.amount.toFixed(2)}</span> -
                        <span class="${statusClass}">${statusText}</span>
                    </p>
                `;
                transactionFeed.prepend(transactionItem);

                if (transactionFeed.childElementCount > 50) {
                    transactionFeed.removeChild(transactionFeed.lastChild);
                }

                if (isFraud) {
                    fraudAlertsCount++;
                    const alertItem = document.createElement('div');
                    alertItem.className = 'py-1 border-b border-red-700 animate-pulse flex justify-between items-center';
                    alertItem.innerHTML = `
                        <div>
                            <p class="text-red-400 font-bold">
                                <span class="font-mono">${transaction.timestamp}</span> - High-Risk Txn -
                                <span>$${transaction.amount.toFixed(2)}</span>
                            </p>
                            <p class="text-xs text-gray-400">Model: ${prediction.model_name}, Prob: ${prediction.probability.toFixed(4)}</p>
                        </div>
                        <button class="dismiss-btn px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded-full">Dismiss</button>
                    `;
                    alertFeed.prepend(alertItem);

                    const dismissBtn = alertItem.querySelector('.dismiss-btn');
                    dismissBtn.addEventListener('click', () => {
                        alertItem.remove();
                    });

                    if (alertFeed.childElementCount > 50) {
                        alertFeed.removeChild(alertFeed.lastChild);
                    }
                }

                // Update Key Metrics
                metricTotalTxns.textContent = totalTxns;
                metricFraudAlerts.textContent = fraudAlertsCount;
                metricTsRegret.textContent = mabs.ts_regret.toFixed(2);
                metricUcb1Regret.textContent = mabs.ucb_regret.toFixed(2);

                // Update performance insights
                let insightText = '';
                if (mabs.ts_regret < mabs.ucb_regret) {
                    insightText = `With a cumulative regret of <span class="text-pink-400 font-bold">${mabs.ts_regret.toFixed(2)}</span>, <span class="text-pink-400 font-bold">Thompson Sampling</span> is proving to be the more adaptive and efficient model by making better decisions over time.`;
                } else if (mabs.ucb_regret < mabs.ts_regret) {
                    insightText = `With a cumulative regret of <span class="text-blue-400 font-bold">${mabs.ucb_regret.toFixed(2)}</span>, <span class="text-blue-400 font-bold">UCB1</span> is currently performing better, showing a more effective exploration-exploitation balance in this simulation.`;
                } else {
                    insightText = 'Both models are performing similarly. The simulation is still in its early stages.';
                }
                performanceInsights.innerHTML = insightText;

                // Update Cumulative Regret Plot
                regretChart.data.labels.push(step);
                regretChart.data.datasets[0].data.push(mabs.ts_regret);
                regretChart.data.datasets[1].data.push(mabs.ucb_regret);
                regretChart.update('none');

                // Update Precision@100 Chart
                if (data.precision_at_100) {
                    precisionChart.data.datasets[0].data = [data.precision_at_100.ts, data.precision_at_100.lr];
                    precisionChart.update('none');
                }

                // Update Cluster Distribution Plot
                clusterChart.data.datasets[0].data = Object.values(clusterCounts);
                clusterChart.update('none');
            });
        });
    </script>
</body>
</html>
